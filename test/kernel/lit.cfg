# -*- Python -*-

import os
import sys
import re
import platform

try:
   import lit.util
   import lit.formats
except ImportError:
   pass


config.name = 'Seahorn'
config.test_format = lit.formats.ShTest(execute_external=False)
config.suffixes = ['.c', '.ll']

config.test_source_root = os.path.dirname(__file__)
config.test_exec_root = lit_config.params.get('test_dir', '.')
config.useProgressBar= True
config.timeout=30
config.max_time=30

def addEnv(name):
   if name in os.environ:
      config.environment[name] = os.environ[name]
   else:
      lit_config.fatal('environment variable %s is not set' % name)

def isexec (fpath):
    if fpath == None: return False
    return os.path.isfile(fpath) and os.access(fpath, os.X_OK)

def which (cmd):
   return lit.util.which(cmd, config.environment['PATH'])

def getSea ():
   sea = None
   if 'SEAHORN' in os.environ:
      sea = os.environ ['SEAHORN']
   if sea is None or not isexec(sea):
      sea = which('sea')
   return sea

addEnv('HOME')
addEnv('PWD')
addEnv('WLLVM_OBJCOPY')
addEnv('LLVM_COMPILER')
addEnv('LLVM_CC_NAME')
addEnv('LLVM_CXX_NAME')
addEnv('LLVM_LINK_NAME')
addEnv('LLVM_AR_NAME')

repositoryRoot = os.path.dirname (os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
lit_config.note('Repository root is {}'.format(repositoryRoot))

sea_cmd = getSea()
if not isexec(sea_cmd):
   lit_config.fatal('Could not find the sea executable at {}'.format(sea_cmd))
else:
   lit_config.note('Found sea: {}'.format(sea_cmd))

wllvm = which('wllvm')
kernel_dir = os.path.join(repositoryRoot, 'kernel')
vmlinux_bc = os.path.join(kernel_dir, 'vmlinux.bc')
kern_util = os.path.join(repositoryRoot, 'kern-util.c')
extract_bc = which('extract-bc')
llvm_link_14 = which('llvm-link-14')

config.substitutions.append(('%sea', sea_cmd))
config.substitutions.append(('%wllvm', wllvm))
config.substitutions.append(('%vmlinux-bc', vmlinux_bc))
config.substitutions.append(('%kern-util', kern_util))
config.substitutions.append(('%extract-bc', extract_bc))
config.substitutions.append(('%llvm-link', llvm_link_14))
config.substitutions.append(('%kernel-dir', kernel_dir))
